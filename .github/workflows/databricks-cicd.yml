name: deploy-dev

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: development
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_DEV }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_DEV }}
      # Using GitHub variables to build the repo URL dynamically
      REPO_URL: /Workspace/Users/rollux2013@gmail.com/databricks-ingestion-platform

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ensures we can read the git log for the email

      - name: Set up Python
        uses: actions/setup-python@v4

      - name: Extract Commit Author Email and set REPOSITORY_PATH
        id: vars
        run: |
          AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          # Clean email (replaces dots/special chars if needed, though usually not required for paths)
          # echo "REPOSITORY_PATH=/Workspace/Users/rollux2013@gmail.com/databricks-ingestion-platform" >> $GITHUB_ENV

      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      - name: Extract branch name
        id: extract_branch
        run: echo "branch=$(echo ${GITHUB_REF#refs/head/})" >> $GITHUB_OUPUT

      - name: Deploy or Update Repo
        run: |
          # Define the specific target path
          # Ensure this matches your workspace structure: /Workspace/Users/<email>/<dir-name>
          # REPOSITORY_PATH="/Workspace/Users/rollux2013@gmail.com/databricks-ingestion-platform"
          
          echo "Checking for repo at: $REPOSITORY_PATH"

          # 1. Check if the repo exists
          if databricks repos get --path "$REPOSITORY_PATH" > /dev/null 2>&1; then
            echo "Repo exists. Updating to latest main..."
            databricks repos update --path "$REPOSITORY_PATH" --branch "main"
          else
            echo "Repo not found. Creating new repo..."
            