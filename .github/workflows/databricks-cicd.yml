name: Deploy to Dev Databricks

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_DEV }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_DEV }}
      # Using GitHub variables to build the repo URL dynamically
      REPO_URL: "${{ github.server_url }}/${{ github.repository }}.git"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ensures we can read the git log for the email

      - name: Extract Commit Author Email and set REPOSITORY_PATH
        id: vars
        run: |
          AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          # Clean email (replaces dots/special chars if needed, though usually not required for paths)
          echo "REPOSITORY_PATH=/Workspace/Users/$AUTHOR_EMAIL/databricks-repo" >> $GITHUB_ENV

      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      - name: Deploy or Update Repo
        run: |
          # 1. Try to get the repo status
          if databricks repos get "$REPOSITORY_PATH" > /dev/null 2>&1; then
            echo "Repo exists at $REPOSITORY_PATH. Updating to latest main..."
            databricks repos update "$REPOSITORY_PATH" --branch "main"
          else
            echo "Repo not found. Creating new repo at $REPOSITORY_PATH..."
            databricks repos create "$REPO_URL" git-provider "gitHub" --path "$REPOSITORY_PATH"
          fi