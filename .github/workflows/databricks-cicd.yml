name: deploy-dev

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_DEV }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_DEV }}
      # Using GitHub variables to build the repo URL dynamically
      REPO_URL: "${{ github.server_url }}/${{ github.repository }}.git"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ensures we can read the git log for the email

      - name: Extract Commit Author Email and set REPOSITORY_PATH
        id: vars
        run: |
          AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          # Clean email (replaces dots/special chars if needed, though usually not required for paths)
          echo "REPOSITORY_PATH=/Workspace/Users/$AUTHOR_EMAIL/databricks-repo" >> $GITHUB_ENV

      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      - name: Deploy or Update Repo
        run: |
          # Define the specific target path
          # Ensure this matches your workspace structure: /Workspace/Users/<email>/<dir-name>
          REPOSITORY_PATH="/Workspace/Users/${{ env.COMMIT_AUTHOR_EMAIL }}/databricks-ingestion-platform"
          
          echo "Checking for repo at: $REPOSITORY_PATH"

          # 1. Check if the repo exists
          if databricks repos get --path "$REPOSITORY_PATH" > /dev/null 2>&1; then
            echo "Repo exists. Updating to latest main..."
            databricks repos update --path "$REPOSITORY_PATH" --branch "main"
          else
            echo "Repo not found. Creating new repo..."
            # Using --provider "gitHub" (with the double dash) fixes the '3 args' error
            databricks repos create \
              --url "$REPO_URL" \
              --provider "gitHub" \
              --path "$REPOSITORY_PATH"
          fi